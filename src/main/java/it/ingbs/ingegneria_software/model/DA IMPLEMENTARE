public void leggiDaTXT(String nomeFile) throws IOException {
    try (BufferedReader reader = new BufferedReader(new FileReader(nomeFile))) {
        String line;
        while ((line = reader.readLine()) != null) {
            // Processa ogni riga del file 
            String[] parts = line.split(" -> |: | [ | / | ]");  // Divide la riga in base ai separatori (ho aggiunto quelli in piu)

            if (parts.length == 3) {
                String categoria1 = parts[0].trim();
                String categoria2 = parts[1].trim();
                double valore = Double.parseDouble(parts[2].trim());
                String descrizione1 = part[3].trim();
                String descrizione2 = part[4].trim();

                // Crea le categorie (potresti voler gestire le categorie come oggetti)
                CategoriaFoglia c1 = new Categoria(categoria1,descrizione1); 
                CategoriaFoglia c2 = new Categoria(categoria2,descrizione2);
                // Aggiungi il fattore di conversione alla mappa
                FattoreConversione fattore = new FattoreConversione(c1, c2, valore);
                fattoriConversione.put(categoria1 + "->" + categoria2, fattore);
            }
        }
    }
    /*
    OSS: Metoto per la lettura da file modificato, ora legge anche le descrizioni. (Se da problemi è da rivedere la line.split)
    */

    public void esportaInTXT(String nomeFile) throws IOException {
        try (FileWriter writer = new FileWriter(nomeFile)) {
            // Itera sulla mappa dei fattori di conversione e scrive ogni coppia su una riga
            for (FattoreConversione fattore : fattoriConversione.values()) {
                // Scrive la riga con le categorie e il valore del fattore
                writer.append(fattore.getCategoria1().getNome() + " -> " +
                              fattore.getCategoria2().getNome() + ": " +
                              fattore.getValore() + "\n");
            }
        }
    }
}


//POSSIBILI METODI PER IL SALVATAGGIO E LA LETTURA DEI VALORI DI CONVERSIONE E DELLE CATEGORIE A LORO ASSOCIATI. 

//oss: LETTURA DA ESEGUIRE ALL'AVVIO DEL PROGRAMMA, SCRITTURA DA ESEGUIRE QUANDO SI SALVANO LE MODIFICHE (OPZIONE SCELTA DAL MENU DEL CONFIGURATORE).



//GESTORE FATTORI DI CONVERSIONE

package it.ingbs.ingegneria_software.model;

import java.io.File;
import java.io.FileWriter;
import java.io.IOException;
import java.util.HashMap;

import it.ingbs.ingegneria_software.model.gerarchie.CategoriaFoglia;
import it.ingbs.ingegneria_software.model.gerarchie.GestoreCategorie;
import it.ingbs.ingegneria_software.utilita_generale.InputDati;
import it.ingbs.ingegneria_software.utilita_generale.MenuUtil;




public class GestoreFattoriConversione {
    
    GestoreCategorie gestoreCat = new GestoreCategorie();
    private HashMap<String,FattoriConversione> mappaFattori;
    File nomeFile = new File("src\\Data File\\elencoFattoriConversione.txt");
    

    /*
     * assegno un fattore di conversione tra 2 categorie foglia 
     */
    private void assegnaFattoreConversione(CategoriaFoglia categoria1, CategoriaFoglia categoria2, double valore){
        //creo la chiave che è data dal nome delle 2 categorie foglia
        String chiave = categoria1.getNome()+" -> "+categoria2.getNome();
        
        //creo un fattore di conversione e lo aggiungo alla mappa dei fattori
        FattoriConversione fattore = new FattoriConversione(valore, categoria1, categoria2);
        mappaFattori.put(chiave,fattore);
        
        //creo in automatico il fattore opposto.
        fattoreOpposto(categoria1, categoria2, valore);

    }


    /*
     * Crea un fattore di conversione opposto rispeto a quello appena creato. 
     */
    private void fattoreOpposto(CategoriaFoglia categoria1, CategoriaFoglia categoria2, double valore)
    {
        String chiaveOpposta = categoria2.getNome()+" -> "+categoria1.getNome();

        FattoriConversione fattoreOpposto = new FattoriConversione(1/valore, categoria2, categoria1);
        mappaFattori.put(chiaveOpposta,fattoreOpposto);
    }




    /*
     * Controllo se esistono i valori di conversione da 1 a 2 e da 2 a 3, se esistono creo il valore da 1 a 3 e lo aggiungo alla mappa.
     */
    public void fattoreDerivato(CategoriaFoglia cat1, CategoriaFoglia cat2, CategoriaFoglia cat3){
        String controllo12 = cat1.getNome()+" -> "+cat2.getNome();
        String controllo23 = cat2.getNome()+" -> "+cat3.getNome();
        if(mappaFattori.containsKey(controllo12) && mappaFattori.containsKey(controllo23)){
            double val1 = mappaFattori.get(controllo12).getValore();
            double val2 = mappaFattori.get(controllo23).getValore();
            double valDerivato = val1*val2;

            //aggiungo il valore derivato alla mappa (da cat1 a cat3)

            assegnaFattoreConversione(cat1, cat3, valDerivato);
        }
        
    }


    /*
     * metodo che permette di salvare i fattori di conversione su file txt
     * Salva nome delle categorie, valore di conversine ed eventuali descrizioni. (possibili modifiche da apportare se i dati vengono 
     * salvati in modo sbagliato) 
     */
     public void salvaFattori(File nomeFile2) throws IOException {
             try (FileWriter writer = new FileWriter(nomeFile2)) {
            // Itera sulla mappa dei fattori di conversione e scrive ogni coppia su una riga
            for (FattoriConversione fattore : mappaFattori.values()) {
                // Scrive la riga con le categorie e il valore del fattore
                writer.append(fattore.getCategoria1().getNome() + " -> " +
                              fattore.getCategoria2().getNome() + ": " +
                              fattore.getValore() + "["+
                              fattore.getCategoria1().getDescrizione()+"/"+
                              fattore.getCategoria2().getDescrizione()+"]"+
                               "\n");
            }
        }
    }

    
    /*
     * visualizza le categoria foglia e in seguito crea un fattore di conversione.
     */
    public void nuovoFattore(){
        gestoreCat.visualizzaCatFoglia();
        CategoriaFoglia cat1 = getCat();
        CategoriaFoglia cat2 = getCat();
        double valore = InputDati.leggiDoubleLimitato("Inserisci il fattore di conversione:", 0.5, 2);
        assegnaFattoreConversione(cat1,cat2,valore);
    }


    private CategoriaFoglia getCat () {
        String nome = InputDati.leggiStringaNonVuota("Inserisci il nome della categoria");		
        return gestoreCat.cercaCatFoglia(nome);
    }


    /*
     * menu che permette di eseguire operazioni sui fattori di conversione
     */
    public void modificaFattori() throws IOException{
        String [] voci = {"Aggiungi fattore di conversione","Salva fattori di conversione",
        "Visualizza fattori di conversione"};
        MenuUtil menuFattori = new MenuUtil("AZIONI SUI FATTORI DI CONVERSIONE",voci);
        int scelta=0;
        do{
           scelta=menuFattori.scegli();
           switch(scelta){
            case 1:
              nuovoFattore();
            break;

            case 2:
             salvaFattori(nomeFile);
             break;

            case 3: 
            //visualizzaFattori();
            break;
           }
        }while(scelta!=0);
    }
}


/* 
 * Per capire se una categoria è foglia bisogna vedere se possiede dei figli. 
 * -serve metodo per vedere se ha figli (non ricordo se esiste già)
 * -posso usare i metodi che avevo già fatto per la creazione del fattore diretto/inverso e derivato 
 * 
 */